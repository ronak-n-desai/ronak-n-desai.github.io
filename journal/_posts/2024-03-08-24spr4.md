---
layout: post
title: Log-Scaling Correction, Grid Searches
use_math: true
category: journal
---

# Log-Scaling Correction

## Log-Scaling Correction Derivation
As I've mentioned [previously](https://ronak-n-desai.github.io/24spr3/), the log-scaling skews the predictions of a ML model. In fact, it always makes the ML model under-predict the true function. 
The log normal distribution (see [wikipedia](https://en.wikipedia.org/wiki/Log-normal_distribution) page) is what I am using to add noise to the output energies. The relevant formula is 

\begin{equation}
  \mu = \log(\frac{\mu_X^2}{\sqrt{\mu_X^2 + \sigma_X^2}})
\end{equation}

Here, $\mu_X$ would be the value of the output energy. After log-scaling, the model will ideally learn the output energy to be $\mu$. When we exponentiate the model prediction, we will be left with $\exp(\mu) < \mu_X$. This is the origin of the under-prediction

The PDF of the log-normal distrubution is 

\begin{equation}
  f(x) = \frac{1}{x \sigma \sqrt{2 \pi}} \exp\left(- \frac{(\log(x) - \mu)^2}{2 \sigma^2} \right)
\end{equation}

where $\mu = \log\left(\frac{\mu_X}{\sqrt{1 + \alpha^2}} \right)$ is the mean of the logged distribution, $\sigma^2 = \log(1 + \alpha^2)$ is the variance of the logged distribution, and $\alpha = \sigma_X / \mu_X$ is the noise level of the original (log-normal) distribution. Additionally, $\mu_X$ and $\sigma_X$ are the mean and variance of the log-normal distribution. 

The expected value $E[x]$ = \mu_X can be confirmed by taking $\int_0^\infty x f(x)$ (I just used Mathematica). To get the expected value of the log of this distribution, we can take $\int Log(x) f(x) = \log\left(\frac{mu_X}{\sqrt{1 + \alpha^2} } \right) = \mu$ which makes sense due to our definition of $\mu$. We can calculate the underprediction bias as a percentage as

\begin{equation}
\text{bias} = \frac{\mu_X - e^\mu}{\mu_X} \times 100 \% = \frac{\sqrt{1 + \alpha^2} - 1}{\sqrt{1 + \alpha^2} \times 100 \%
\end{equation}

## Techniques to Implement Prediction Correction
To fix this underprediction bias, we would want to multiply the predictions by a correction factor equal to $\mu_X / e^\mu$ 


