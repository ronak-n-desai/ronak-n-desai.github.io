---
layout: post
title: Closing the Loop
use_math: true
category: journal
---

This post covers work from 04/09 to 04/19. I worked with Nathaniel to try to close the loop by implementing a basic optimization script that can send commands back to the EPICS server. Additionally, we submitted the synthetic data paper to ar$\chi$iv and Journal of Plasma Physics as well.

# Updated Oprimization Script
Changes: 
- Placement of constants in  `constants.py` so that the script doesn't need to be directly edited
- Incorporated Waveplate information by fitting linear regression to $\cos(\theta - \theta_0)^2$ to establish proper mapping of diode to waveplate data
- Added flags for `MANUAL_MODE` so that we can control whether the opimization runs automatically or manually.

## 04/11 Preliminary Analysis
I collected data with Nathaniel today, but there are some issues with the data.

1. The Pspec Data didn't get saved, even though the data server was running. 

2. The Pre-Pulse Looping program didn't appear to be running. This can be seen in the following figure taken from the Looping Controls data (where the PP WP is stuck at 4 degrees):
   
![9a5e87b2-46ec-46c3-898f-cbc7927d9a8b](https://github.com/ronak-n-desai/ronak-n-desai.github.io/assets/98538788/ba1f99dc-30e7-40df-9a6d-668e195843b2)

Now, the `reduced_max` variable is absent from the DIODE data and the `reduced_mean` value seems to be nonsense

![image](https://github.com/ronak-n-desai/ronak-n-desai.github.io/assets/98538788/f743e416-69ab-4fea-95d0-d1168c483a8a)

On the other hand, there is this new term called `global_peak5` which appears to roughly move up and down like an intensity would:

![image](https://github.com/ronak-n-desai/ronak-n-desai.github.io/assets/98538788/bef3bfd4-d7ae-41bf-b3f4-3220072cc091)

However, I'm not sure what this is and how it makes sense if the waveplate looping program is not updating the PP angle. Also, the MP and PP programs have the same period, so it can't be related to the intensity (at least that's my best guess).

3. In the one of the above figures, the MP Waveplate had a smaller step size at an angle measure of 20 degrees (which corresponds to the calibrated angle for maximum intensity) and a larger step size at a measure of 40 degrees. This should actually be the exact opposite. I presume the same could apply to the PP if it had been looping properly.

With this said, there appears to be some things that went well:

1. The Nozzle Focus is looping correctly:

![image](https://github.com/ronak-n-desai/ronak-n-desai.github.io/assets/98538788/47cad2e4-969b-46ca-8c00-5eb7ef295e47)

2. The E-Spec Data appears to make sense

![image](https://github.com/ronak-n-desai/ronak-n-desai.github.io/assets/98538788/9d277e61-0c06-4136-a6f4-bcd743a3f4e1)

## 04-15 Data

I spent some time on 04-12 and the weekend making a GUI to make the analysis of the data a little bit easier.

There were three separate DAQ runs (DAQ1 - 11:48AM to 12:29PM, DAQ2 - 1:58PM to 2:25PM, DAQ3 - 2:44PM to 3:08PM). All the DAQ runs had calibrated max MP and PP Waveplate angles at 118 and 12 degrees respectively (and looped down to 100 and 0 degrees respectively as well).

## Data Distribution

Nathaniel's looping program seemed to work well enough, here are histograms of collected MP, PP, and focus positions from DAQ1 after filtering out runs that had zero electron counts:

![image](https://github.com/ronak-n-desai/ronak-n-desai.github.io/assets/98538788/07cd706d-a396-492b-9e51-2b4d2306976f)

![image](https://github.com/ronak-n-desai/ronak-n-desai.github.io/assets/98538788/ee2f79e7-5dae-4698-8257-b4cb5242421b)

![image](https://github.com/ronak-n-desai/ronak-n-desai.github.io/assets/98538788/ce834b5b-9bfd-4ffb-afc7-164803ab51b9)

As before, it seems necessary to filter out data points that have electorn counts less than 100,000 due to the following correlation plot

![image](https://github.com/ronak-n-desai/ronak-n-desai.github.io/assets/98538788/af6951ab-1e81-4f9a-8ccb-1f2c6ec74937)

and we can identify that there are really only three potential locations of focus value that electrons were seen:

![image](https://github.com/ronak-n-desai/ronak-n-desai.github.io/assets/98538788/416d06a9-3573-4a38-9a11-275165d135b0)

even though we looped all the way from 12.45 to 12.57 mm in the focus position.

Looking directly at the waveplate angles over the course of the run, we can see the looping software is doing what its supposed to do (bigger step closer to calibrated angle, smaller step away from calibrated angle): 

![image](https://github.com/ronak-n-desai/ronak-n-desai.github.io/assets/98538788/ad10df7d-fc9a-4283-b358-fd1d78fe5eee)

and from the DIODE data, the voltages are varying more linearly which is better

![image](https://github.com/ronak-n-desai/ronak-n-desai.github.io/assets/98538788/2eab320a-d442-40f2-93df-e16b39a44906)

## Waveplate Calibration
The waveplates calibration seemed to work well for all the plots. I think I can rely on the program to find where the optimal WP angles are: 

![image](https://github.com/ronak-n-desai/ronak-n-desai.github.io/assets/98538788/50226dc5-aa45-4b56-b525-5c444ba017d1)

## Summary Table

Here is a Table that summarizes all the interesting locations where we saw electrons throughout all 3 DAQ runs

![image](https://github.com/ronak-n-desai/ronak-n-desai.github.io/assets/98538788/a078605f-dcba-4936-b1fb-1c70a054ea28)

<!-- 
| Quantity | Range | DAQ1(99) | DAQ2(14) | DAQ3(5) |
| ------ | ------ | ------ | --- | --- |
| MP | 18000-30000 | 26600,27500 | ~29400 | ~26000 |
| PP | 1000-50000 | 8000,9500,12000 | ~7100 | ~7950 |
| Focus | 12.45 - 12.57 | 12.486, 12.5, 12.515 | ~12.5 | ~12.45 |
| Optimum | (MP, PP, Focus) | (26593, 11538, 12.486) | (29372, 7151, 12.509) | (26086, 7954, 12.447) | 
-->

where I've put in parenthesis the amount of data points in the DAQ run that have over 100000 electron CCD counts.

# 04-18 Data
On Thursday, we collected some more data. The signals didn't look great because the Mightex cameras were misaligned.

## Optimization GUI
![image](https://github.com/ronak-n-desai/ronak-n-desai.github.io/assets/98538788/43ffed33-cb56-4fca-ad06-baf279224cb5)

This Interface allows me to do the following things: 
- View histograms for the distribution of variables
- View scatter plots comparing variables to each other
- Show the plot of Diode Voltage against Angle with indicated calibration vline
- Show variable vs shot number
- Train a regression model and show the optimization result

## Spectrum GUI
![image](https://github.com/ronak-n-desai/ronak-n-desai.github.io/assets/98538788/4ee1e8d7-81dc-40d0-b031-5571b4bbf91f)

This Interface allows me to do the following things: 
- View the electron/proton spectra throughout the day
- Pick a particular data point and see the spectra along with gaussian fit
- Pick a particular data point and view histograms with specified number of bins where the x-axis is not Energy in MeV instead of pixel number

# To Do
- Update Spectrum GUI to take an arbitrary number of bins
- Update Spectrum GUI to load the data faster
- Add a script to consolidate the data into a pandas df, add a column with a DAQ ID Code, and save to hdf5 file.
- Should also save timestamps so that we can further filter data
- Add Gaussian Fit Metrics to Dataframes
- Fix PP calibration
- Save Misc Info to Txt File: Linear Regression for MP + PP, Ridge HPs, 
