---
layout: post
title: 03/14 Data, Matlab code
use_math: true
category: journal
---
This week, I have been working on updates to the synthetic data paper as well as looking through data from Monday 03/11. I just collected data on 03/14 where we ran the looping program for both the target (Nozzle Focus) and the Waveplate (Main Pulse Angle). I also work on getting all the data into one consolidated file anchored by the shot number and time.

# 03/14 Data
We were able to get two DAQ runs, the second of which we were able simultaneously run the target looping program and the main pulse waveplate rotating program.

## Target Data
The target data collected throughout the day can be summarized by the following plot

![image](https://github.com/ronak-n-desai/ronak-n-desai.github.io/assets/98538788/e65be187-ee82-4843-85b1-1dcac0a28725)

We can still see that the target data timestamp is still off by around 24 seconds. I also looked at the 121st target file (which falls within the start of DAQ2) which had the same 24 second time difference. Actually, when looking back at the data from 03-11, I also find this 24 second time difference. It seems to be around 24.2 seconds.

## Diode Data

After thinking more about the time information, I realized it is import to specify the timezone, that could be a significant cause for concern between the different files. The Unix time is something that is standardized and represents time since 1970 in seconds in the coordinated universal timezone (UTC). I am running code from my computer in the eastern timezone (which is 4 hours behind UTC b/c we are currently in daylight savings time EDT). 

Here are time results for the DIODEs during DAQ1:

![image](https://github.com/ronak-n-desai/ronak-n-desai.github.io/assets/98538788/332865f3-96f5-4b76-9cd1-05a290e42906)

I again see a drift in the times between the main pulse and prepulse. Last time, there was a drift of 13.159ms/1000 shots. Here, it looks like a drift of 13.2ms/1000 shots (which is the same!). As a result, it seems like there is definitely a drift, but we may be able to account for it if it stays a constant. This time, the initial time offset was different even though I ran ntpdate more often than the last time. Looking at the second DAQ run:

![image](https://github.com/ronak-n-desai/ronak-n-desai.github.io/assets/98538788/22603db9-544b-43b1-96e9-82fc3d818463)

We see the same 13.2ms/1000 shots drift as before. This time, both diodes were exactly aligned at 0 seconds time difference, which is good. If I were to guess, I might have restarted both beaglebone servers and ran ntpdate just prior to the second DAQ run, but I don't remember if I did or not.

This time, we ran the looping program for the Main Pulse Waveplate which can easily be seen on the diodes around halfway through the DAQ: 

![image](https://github.com/ronak-n-desai/ronak-n-desai.github.io/assets/98538788/3792ddcc-a962-4ed0-b035-cfb69014d1aa)

and since the prepulse shutter was closed, we don't get any reading from the prepulse diode

![image](https://github.com/ronak-n-desai/ronak-n-desai.github.io/assets/98538788/161d0779-c9cc-4982-ac93-5a9de1190ada)

## Espec and Pspec Data

We were able to capture electrons in this data: here are spectra from three of the highest counts: 

![image](https://github.com/ronak-n-desai/ronak-n-desai.github.io/assets/98538788/d465174c-ad47-4a48-af45-951dcff80679)

I will need to do a more detailed analysis to determine where exactly the electron spectra was higher in terms of target conditions. First, I'm going to try to combine all the relevant information into a consolidated dataframe for easier analysis with shot times aligned. I will need to take into account the various time drifts and timezone differences to do this.

The good thing about this run is that the triggers were completely stable, the difference in trigger count didn't change between the Pspec and Espec (up to when the Pspec froze at 4916). Additionally, it looks like none of the triggers were dropped, they increment by one the whole time. From last time, I calculated about a 30.8ms drift per 1 second of data collection. This time, I have around 28.8ms of drift per 1 second of data collection:

![image](https://github.com/ronak-n-desai/ronak-n-desai.github.io/assets/98538788/de9cedf6-8aa6-4f91-895a-5efef5fd1333)

## Waveplate Data

Consistent with the Diode data, I've captured the looping portion of the waveplate data in the last half of the DAQ run

![image](https://github.com/ronak-n-desai/ronak-n-desai.github.io/assets/98538788/e035c78f-9574-441d-b417-5c7d974c7172)

# MATLAB code explanation
I tried looking through the MATLAB code that converts the pixel number to an energy value, but it was very difficult to read and I couldn't make sense of things. Instead, I will just explain the simplified explanation that depends on only a constant B field explained [here](https://pubs.aip.org/aip/rsi/article/82/3/033506/359441/Design-of-and-data-reduction-from-compact-Thomson). 

The deflection can be described by the following picture: An positive ion of velocity $v_0$ traveling along the $z$ axis gets deflected upwards (positive x axis) by a magnetic field that points into the page (-y direction) in the region between $z=0$ and $z=z_B$. After the ion leaves this region (i.e. when $z > z_B$), the ion is left to coast in a straight line until it hits the detector at $z = z_o$. This can be visualized in the following picture taken from the paper: 

![image](https://github.com/ronak-n-desai/ronak-n-desai.github.io/assets/98538788/3fe3455b-6cfe-473a-a3f4-c1291fe26ac1)

If the cyclotron radius $r_c = \frac{m v_0}{q B}$, then the location at the detector $x$ and the deflection angle $\phi$ can be calculated as 

\begin{equation}
  x = \frac{z_o  - z_B}{\sqrt{(r_c/z_B)^2 - 1}} + r_c (1 - \sqrt{1 - (z_B/r_c)^2})
\end{equation}

and 

\begin{equation}
  \phi = \arctan( ((r_c/z_B)^2 - 1)^{-1/2} )
\end{equation}

A picture from [Morrison et al.](https://iopscience.iop.org/article/10.1088/1367-2630/aaa8d1) shows how the electrons/protons enter the magnetic spectrometer region.

![image](https://github.com/ronak-n-desai/ronak-n-desai.github.io/assets/98538788/174c68e6-c3aa-4d1f-b459-b99909d41d48)

so the above prescription is applicable for the protons. To look at the electrons

# Looking through data from 03-18

The data isn't all that different from the previous runs, so I'm just going to summarize some of the findings here: 
- There is still the 13.2 ms drift per 1000 shots between the DIODE data
- There is still the 32.47 ms drift per 1 seconds of data collection in the Mightex data

This time, we looped through both the main pulse and prepulse. It can be seen that the prepulse looping is happening on a much faster time scale than the main pulse

![image](https://github.com/ronak-n-desai/ronak-n-desai.github.io/assets/98538788/c555d2ef-4b62-49ac-a09d-7ecdd4d723e5)


# Combining Code in one Dataframe

I wrote some code (and used a lot of Scott's code) to create one big h5 file for each type of data and then combine the h5 files into a pandas df for further analysis merged on the shot number. One thing I decided to do was to look back at previous days of data to see if I could find anything. On 03/11, we lowered the exposure time to 1ms and I wasn't able to gather anything from that. 

I decided to create some metrics that can tell us something about the spectrum (change `ele` to `pro` for protons). 
1. The `ele_num` is the total number of counts (added across each row of 3648 pixels). First, I subtract a noise value off (which I have chosen to be 600 for electrons, but can be adjusted later)
2. The `ele_max_pixel` is the pixel such that all pixels below it comprise 95 percent of total electron counts
3. The `ele_avg_pixel` is the average pixel number weighted by electron counts

## 03/14
On 03/14, we collected some data that looped through the target and main pulse with no prepulse between `14:13` and `14:30`. We were able to get some electrons which can be seen in the following graph

![image](https://github.com/ronak-n-desai/ronak-n-desai.github.io/assets/98538788/cca7c94b-295a-4294-9698-fd7793b199c2)

where the spectra are sorted from lowest to highest electron counts from bottom to top. 

Some extremely weak positive correlations can be seen between the main pulse intensity and the electron number, average pixel, and max pixel (where I only chose spectra with more than 1 million electron counts):

![image](https://github.com/ronak-n-desai/ronak-n-desai.github.io/assets/98538788/1d122e56-654c-4a3c-a37b-8634535938e7)

Here is a plot that visualizes where the average and max energies lie for 4 randomly chosen electron spectra (with more than 1 million electron counts)

![image](https://github.com/ronak-n-desai/ronak-n-desai.github.io/assets/98538788/f2ebe1ed-94e2-4c7f-b3b1-767ff881f6b7)

## 03/18

The electron spectra looked similar to last time:

![image](https://github.com/ronak-n-desai/ronak-n-desai.github.io/assets/98538788/06f8fdff-bada-4fcf-b47f-cedf3b22a6c3)

the correlation plots looked a little more interesting this time.

![image](https://github.com/ronak-n-desai/ronak-n-desai.github.io/assets/98538788/8c145489-f322-4682-9392-62bce64abc50)

We can see a positive correlation between average/max pixel number and pre-pulse and slight negative correlation between average/max pixel and main pulse. If I were to guess, this would be because if both the prepulse and main pulse are too high, we would just punch through the target and not see as many electrons. 

Additionally, we can see a negative correlation between the main pulse intensity and pre pulse intensity. This reflects the fact that the main pulse spends more time in a higher intensity region and the prepulse spends more time in a lower intensity due to the way the looping program works. The intensities both follow a $\cos^2(\theta)$ profile and the MP is nearer to 90 degrees and the PP is closer to 0 degrees. This can be visualized in the following graphic (not actual data, just a visual that conveys the idea):

![image](https://github.com/ronak-n-desai/ronak-n-desai.github.io/assets/98538788/972a17b7-4e3e-4b6a-b564-af8798fe6dd5)

where the solid lines are proportional to $\cos^2$ of the dotted lines. Also, here's another plot showing 4 random spectra (with over a million electron counts) plotted with the max and average pixel number 

![image](https://github.com/ronak-n-desai/ronak-n-desai.github.io/assets/98538788/9d492852-5fba-463d-83fb-7bceb63158e1)

# Some Adjustments on Correlation Plots

Here is a plot (only restricting to electron ccd counts > 0) with correlations between electron number, main pulse, and prepulse (which have very little correlation)

![image](https://github.com/ronak-n-desai/ronak-n-desai.github.io/assets/98538788/567f9c39-ad3f-44f5-b0bc-9e2640c20944)

Here is the same plot I had in the last section (with electron counts > 1 million) but with smaller marker sizes

![image](https://github.com/ronak-n-desai/ronak-n-desai.github.io/assets/98538788/5ba537c8-0284-4301-9f4c-cc4ed3f4bf80)

# To Do
- Make Simple ML Training Program: MP, PP -> Espec and extract any trends
- Find Mapping between PP and MP Waveplate Angle and Diode Intensity
- Try to match up Target Data with Waveplate and Nucleo Data
- Deal with overflow of shot number in Mightex Data
- 
